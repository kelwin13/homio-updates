name: Push firmware update

on:
  workflow_dispatch:

jobs:
  push-firmware:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Get latest release version
        id: latest
        run: |
          VERSION=$(curl -s https://api.github.com/repos/kelwin13/homio-updates/releases/latest | jq -r .tag_name)
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify firmware binary exists
        run: |
          BIN_FILE="firmware-v${{ steps.latest.outputs.version }}.bin"
          if [ ! -f "$BIN_FILE" ]; then
            echo "‚ùå –§–∞–π–ª $BIN_FILE –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ."
            exit 1
          fi
          if [ ! -s "$BIN_FILE" ]; then
            echo "‚ùå –§–∞–π–ª $BIN_FILE –º–∞—î –Ω—É–ª—å–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä."
            exit 1
          fi

      - name: Calculate checksum
        id: checksum
        run: |
          CHECKSUM=$(sha256sum "firmware-v${{ steps.latest.outputs.version }}.bin" | cut -d ' ' -f1)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: Generate firmware.json
        run: |
          echo '{
            "version": "'${{ steps.latest.outputs.version }}'",
            "date": "'$(date +%Y-%m-%d)'",
            "url": "https://github.com/kelwin13/homio-updates/releases/download/v${{ steps.latest.outputs.version }}/firmware-v${{ steps.latest.outputs.version }}.bin",
            "checksum": "'${{ steps.checksum.outputs.checksum }}'",
            "notes": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏"
          }' > firmware.json

      - name: Push to homio-updates
        run: |
          git config --global user.name "homio-bot"
          git config --global user.email "homiobot3@gmail.com"
          git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/kelwin13/homio-updates.git

          cp firmware.json homio-updates/
          cp firmware-v${{ steps.latest.outputs.version }}.bin homio-updates/

          if [ ! -f "homio-updates/firmware.json" ] || [ ! -f "homio-updates/firmware-v${{ steps.latest.outputs.version }}.bin" ]; then
            echo "‚ùå –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –Ω–µ –≤–¥–∞–ª–æ—Å—è."
            exit 1
          fi

          cd homio-updates
          git add firmware.json firmware-v${{ steps.latest.outputs.version }}.bin
          git commit -m "Update firmware metadata v${{ steps.latest.outputs.version }}" || echo "‚ÑπÔ∏è –ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∫–æ–º—ñ—Ç—É"

          echo "üì¶ –°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –ø—É—à–µ–º:"
          git status
          git log -1

          git push || (echo "‚ùå Push –Ω–µ –≤–¥–∞–≤—Å—è." && exit 1)
